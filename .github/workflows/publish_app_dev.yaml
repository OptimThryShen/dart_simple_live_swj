name: app-build-action-dev
on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # ğŸŸ¢ ç¬¬ä¸€æ­¥ï¼šç°åœºç”Ÿæˆä¸€ä¸ªç­¾åè¯ä¹¦ (Keystore)
      - name: Generate Keystore
        run: |
          # è¿›å…¥å®‰å“ç›®å½•
          cd simple_live_app/android/app
          # ä½¿ç”¨ keytool ç”Ÿæˆä¸€ä¸ªæœ‰æ•ˆæœŸ 10000 å¤©çš„è¯ä¹¦
          keytool -genkey -v -keystore my-release-key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias my-alias -storepass 123456 -keypass 123456 -dname "CN=User, OU=User, O=User, L=City, S=State, C=US"

      # ğŸŸ¢ ç¬¬äºŒæ­¥ï¼šåˆ›å»ºé…ç½®æ–‡ä»¶æŒ‡å‘åˆšæ‰ç”Ÿæˆçš„è¯ä¹¦
      - name: Create key.properties
        run: |
          cd simple_live_app/android
          echo "storePassword=123456" > key.properties
          echo "keyPassword=123456" >> key.properties
          echo "keyAlias=my-alias" >> key.properties
          # æŒ‡å‘æˆ‘ä»¬åœ¨ä¸Šä¸€æ­¥ç”Ÿæˆçš„ my-release-key.jks
          echo "storeFile=my-release-key.jks" >> key.properties

      # ğŸŸ¢ ç¬¬ä¸‰æ­¥ï¼šç¼–è¯‘çœŸæ­£çš„ Release ç‰ˆ (å»æ‰äº† --debug å‚æ•°)
      - name: Build Android APK (Release)
        run: |
          cd simple_live_app
          flutter pub get
          # å…³é”®ï¼šè¿™é‡Œç”¨ --releaseï¼Œç•Œé¢å°±å¹²å‡€äº†
          flutter build apk --release --no-tree-shake-icons --build-name=1.0.0 --build-number=1
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          # æ³¨æ„ï¼šè·¯å¾„é‡Œçš„ debug å˜æˆäº† release
          path: simple_live_app/build/app/outputs/flutter-apk/app-release.apk
